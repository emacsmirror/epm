#!/bin/sh

EPM_VERSION="0.1"

EPM=$(basename $0)
EPM_DIRECTORY=$(dirname $0)

EMACS=${EMACS:-emacs}
EMACS_FLAGS="-Q --batch -l $EPM_DIRECTORY/epm.el"

usage () {
    cat <<EOF
$EPM - Emacs Package Manager

Usage:
    $EPM <command>
    $EPM [option]

Commands:
    list                List installed packages
    install             Install a package
    delete              Delete a package
    refresh             Download package archives
    info                Display information about a package
    search              Search packages
    outdated            List outdated packages
    upgrade             Upgrade outdated packages

Options:
    -h, --help          Display this message
    -v, --version       Print version info and exit

Environment Variable:
    EMACS               The command name or executable path of Emacs

Configuration File:
    ~/.epm.el           The file contains code to bootstrap package.el
                        Refer to $EPM_DIRECTORY/.epm.el.sample as an example

WARNING: Tested with only Emacs 24.5 and 25.2 (trunk)
EOF
}

list () {
    $EMACS $EMACS_FLAGS -f epm-list
}

install () {
    $EMACS $EMACS_FLAGS --eval "(epm-install \"$1\")"
}

delete () {
    $EMACS $EMACS_FLAGS --eval "(epm-delete \"$1\")"
}

refresh () {
    $EMACS $EMACS_FLAGS -f package-refresh-contents
}

info () {
    $EMACS $EMACS_FLAGS --eval "(epm-info \"$1\")"
}

search () {
    $EMACS $EMACS_FLAGS --eval "(epm-search \"$1\")"
}

outdated () {
    $EMACS $EMACS_FLAGS -f epm-outdated
}

upgrade () {
    $EMACS $EMACS_FLAGS --eval "(epm-upgrade \"$1\")"
}

COMMAND=$1
case $COMMAND in
    "" | "-h" | "--help")
        usage
        ;;
    "-v" | "--version")
        printf "epm %s\n" $EPM_VERSION
        $EMACS --version | head -n 1
        ;;
    "list" | "install" | "delete" | "refresh" | "info" | "search" | "outdated" | "upgrade")
        shift
        ${COMMAND} $@
        ;;
    *)
        echo "Error: Unknown command: ${COMMAND}"
        exit 1
        ;;
esac
